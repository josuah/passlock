#!/bin/sh
# usage: bin/make-lib lib*/

echo
for x; do x=${x%/}
	echo "include $x/lib.mk"

	for c in "$x"/*.c; do
		printf '%-30s %-30s ' "${c%.c}.o:" "$c"
		sed -rn 's/^#include "([^"]+).h".*$/include\/\1.h/ p' "$c" | xargs echo
	done >$x/lib.mk

	cat <<__EOF__ >>$x/lib.mk

${x} = $(ls "$x"/*.c | sed 's/\.c$/\.o/g' | xargs)
$x.a: \${$x}
	rm -f \${@}
	\${AR} rc \${@} \${$x}
	ranlib \${@}
__EOF__
done

echo
for x; do x=${x%/}
	sed -nr 's/^#include "([^"]+).h".*/lib\1/ p' "$x"/*.c |
		while read dep; do [ -d "$dep" ] && echo "$x.a" "$dep.a"; done
done | tsort | xargs echo lib =
